#!/usr/bin/env python3
"""
LaTeX Generator for Benchmark Suite

Generates publication-ready LaTeX tables:
- WASM module sizes comparison
- Timing statistics table
- Full benchmark results table
"""

from pathlib import Path
from typing import Dict, Optional


class LatexGenerator:
    """Generate LaTeX tables for benchmark results"""
    
    def __init__(self, config):
        self.config = config
        self.output_dir = Path(config.output_dir) / "latex"
        self.output_dir.mkdir(parents=True, exist_ok=True)
        
    def generate_all(self, report):
        """Generate all LaTeX outputs"""
        print("\nðŸ“ Generating LaTeX tables...")
        
        self.generate_module_sizes_table(report)
        self.generate_timing_table(report)
        self.generate_full_results_table(report)
        
        print(f"   Tables saved to: {self.output_dir}")
        
    def generate_module_sizes_table(self, report):
        """Generate WASM module sizes table (single column)"""
        
        latex = r"""% WASM Module Sizes
% Auto-generated by benchmark-suite
\begin{table}[t]
\centering
\caption{WASM Module Sizes}
\label{tab:wasm-sizes}
\begin{tabular}{lrr}
\toprule
\textbf{Module} & \textbf{Size (KB)} & \textbf{Size (MB)} \\
\midrule
"""
        
        for name in ["cpp", "rust"]:
            if name in report.benchmarks:
                b = report.benchmarks[name]
                if b.module_size_bytes > 0:
                    latex += f"{b.display_name} & {b.module_size_kb:,.2f} & {b.module_size_mb:.2f} \\\\\n"
        
        latex += r"""\bottomrule
\end{tabular}
\end{table}
"""
        
        filepath = self.output_dir / "table_module_sizes.tex"
        with open(filepath, 'w') as f:
            f.write(latex)
            
        print(f"   ðŸ“„ Module sizes: {filepath}")
        
    def generate_timing_table(self, report):
        """Generate timing comparison table"""
        
        latex = r"""% Benchmark Timing Results
% Auto-generated by benchmark-suite
\begin{table}[t]
\centering
\caption{Benchmark Timing Results (ms)}
\label{tab:timing-results}
\begin{tabular}{lcccc}
\toprule
\textbf{Implementation} & \textbf{Attestation} & \textbf{Training} & \textbf{Inference} & \textbf{Total} \\
\midrule
"""
        
        for name in ["python", "cpp", "rust"]:
            if name in report.benchmarks:
                b = report.benchmarks[name]
                
                attest = f"{b.attestation.mean:.1f} $\\pm$ {b.attestation.std:.1f}" if b.attestation.n > 0 else "N/A"
                train = f"{b.training.mean:.1f} $\\pm$ {b.training.std:.1f}" if b.training.n > 0 else "N/A"
                infer = f"{b.inference.mean:.2f} $\\pm$ {b.inference.std:.2f}" if b.inference.n > 0 else "N/A"
                total = f"{b.total_time.mean:.1f} $\\pm$ {b.total_time.std:.1f}" if b.total_time.n > 0 else "N/A"
                
                latex += f"{b.display_name} & {attest} & {train} & {infer} & {total} \\\\\n"
        
        latex += r"""\bottomrule
\end{tabular}
\vspace{1mm}
\footnotesize{Values shown as mean $\pm$ standard deviation over """ + str(report.config.get('num_runs', 'N')) + r""" runs.}
\end{table}
"""
        
        filepath = self.output_dir / "table_timing.tex"
        with open(filepath, 'w') as f:
            f.write(latex)
            
        print(f"   ðŸ“„ Timing table: {filepath}")
        
    def generate_full_results_table(self, report):
        """Generate comprehensive results table"""
        
        latex = r"""% Full Benchmark Results
% Auto-generated by benchmark-suite
\begin{table*}[t]
\centering
\caption{Comprehensive Benchmark Results}
\label{tab:full-results}
\begin{tabular}{lccccccc}
\toprule
\textbf{Implementation} & \textbf{Runs} & \textbf{Attest (ms)} & \textbf{Train (ms)} & \textbf{Infer (ms)} & \textbf{MSE} & \textbf{Module Size} & \textbf{CV (\%)} \\
\midrule
"""
        
        for name in ["python", "cpp", "rust"]:
            if name in report.benchmarks:
                b = report.benchmarks[name]
                
                runs = f"{b.successful_runs}/{b.num_runs}"
                attest = f"{b.attestation.mean:.1f}" if b.attestation.n > 0 else "N/A"
                train = f"{b.training.mean:.1f}" if b.training.n > 0 else "N/A"
                infer = f"{b.inference.mean:.2f}" if b.inference.n > 0 else "N/A"
                mse = f"{b.mse.mean:.2f}" if b.mse.n > 0 else "N/A"
                
                if b.module_size_bytes > 0:
                    module_size = f"{b.module_size_kb:.1f} KB"
                else:
                    module_size = "Native"
                    
                # Average CV across timing metrics
                cvs = []
                for metric in [b.attestation, b.training, b.inference]:
                    if metric.n > 0 and metric.cv > 0:
                        cvs.append(metric.cv)
                avg_cv = f"{sum(cvs)/len(cvs):.1f}" if cvs else "N/A"
                
                latex += f"{b.display_name} & {runs} & {attest} & {train} & {infer} & {mse} & {module_size} & {avg_cv} \\\\\n"
        
        latex += r"""\bottomrule
\end{tabular}
\vspace{1mm}
\footnotesize{CV = Coefficient of Variation. Lower CV indicates more consistent performance.}
\end{table*}
"""
        
        filepath = self.output_dir / "table_full_results.tex"
        with open(filepath, 'w') as f:
            f.write(latex)
            
        print(f"   ðŸ“„ Full results: {filepath}")
        
    def generate_statistical_summary(self, report):
        """Generate detailed statistical summary table"""
        
        latex = r"""% Statistical Summary
% Auto-generated by benchmark-suite
\begin{table}[t]
\centering
\caption{Statistical Summary of Training Times}
\label{tab:stats-summary}
\begin{tabular}{lrrrrr}
\toprule
\textbf{Impl.} & \textbf{Mean} & \textbf{Median} & \textbf{Std} & \textbf{Min} & \textbf{Max} \\
\midrule
"""
        
        for name in ["python", "cpp", "rust"]:
            if name in report.benchmarks:
                b = report.benchmarks[name]
                t = b.training
                
                if t.n > 0:
                    latex += f"{b.display_name} & {t.mean:.1f} & {t.median:.1f} & {t.std:.1f} & {t.min:.1f} & {t.max:.1f} \\\\\n"
        
        latex += r"""\bottomrule
\end{tabular}
\footnotesize{All values in milliseconds.}
\end{table}
"""
        
        filepath = self.output_dir / "table_stats_summary.tex"
        with open(filepath, 'w') as f:
            f.write(latex)
            
        print(f"   ðŸ“„ Stats summary: {filepath}")
